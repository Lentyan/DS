# DS
В данном репозитории располагается ML-часть сервиса для прогнозирования спроса на товары 

**Требования к ML сервису**

Штука, которая делает прогноз. Вариант реализации:

Инференс должен выполняться лишь один раз в день.
- Запущенный сервис ходит в БД через API gateway
- получает список товаров, для которых надо выполнить запрос
- по очереди запрашивает информацию для каждого товара, делает инференс, отправляет результат в БД


**Краткое описание:**

Необходимо создать алгоритм прогноза спроса на 14 дней для товаров собственного 
производства. Гранулярность ТК-SKU-День. 

**Задача:**

Разработать интерпретируемую, описывающую правильные
зависимости (повышение цены вызывает логичное падение спроса), модель прогноза спроса.

Дальше необходимо сделать подневной прогноз спроса на тестовом периоде для каждого товара
и магазина, и команда Ленты оценит его качество в сравнении с свершившимся фактом. 
Метрикой качества будет выступать WAPE, посчитанный на уровне товар, магазин, день. Если 
есть пропущенные значения и по каким-то товарам не предоставлен прогноз, прогноз считается
равным нулю.


**Цель:**
Построить модель прогноза спроса, которая позволит минимизировать количество списаний и не допустить "пустых полок".

  

**Описание решения:**
Проведена предобработка данных:

Была проведена группировка к разрезу ТК-SKU-День. т.к. были экземпляры в одном магазине и для одного товара с более, чем одной строкой (промо и не промо). За целевой признак были взяты суммарные продажи за день в разезе ТК-SKU.

Были удалены строки с отрицательными продажами и строки, в которых количество продаж равно нулю, но сумма продаж не равна нулю.

Целевой признак был логарифмирован, т.к. распределение нашего таргета не очень хорошее. Средние продажи всего в несколько штук, но в праздники есть выбивающиеся значения в сотни, и даже тысячи штук.

Проведена генерация новых признаков:

Мы добавили такие переменные, как:

- день недели
- месяц
- праздник
- промо (0/1)
- лаги
- скользящее среднее в разрезах sku
- средние и медианы в различных группировках, за доступный период исторических данных
- экспоненциальное скользящее среднее
- значения yhat(прогноз) и trend, сгенерированные с помощью библиотеки prophet в разрезе SKU
- SKU-ID
- TK-ID
- ед измерения (шт/вес)
Проведена разработка и оптимизация модели:

Мы отсортировали датасет по дате и выделили последние 28 дней, разделив их на две части: 14 дней для валидации и 14 дней для тестирования.

Чтобы исключить подглядывание в будущее, мы сделали дополнительные проверки, чтоб для генерации признаков использовались только исторические данные. А при расчете скользящего среднего - в аргументах прописали, чтоб день прогноза не включался в интервал для расчета.

Для удобства было написано нескоько функций. Одна для генерации признаков, одна для прогноза по заданному периоду. И еще одна - для рекурсивного прогноза на 14 дней. В ней, при генерации признаков учитывается прогноз предыдущего дня.

Использовали модель CatBoostRegressor и встроенную валидацию. Потом проверяли качество на выделенном тестовом наборе данных.

Проведен анализ важности признаков:

С помощью метода катбуста.get_feature_importance мы вывели важность признаков. Многие гипотезы подтвердились. Однако признак "праздник" оказался в конце списка. Либо нужен более долгий период, более одного года, чтоб модель запомнила их. Самыми значимыми признаками оказались:

прогноз от prophet
лаг1 (продажи за вчерашний день)
признак наличия промо
Проведено дообучение модели на всех данных и расчет прогноза для тестовой выборки.
